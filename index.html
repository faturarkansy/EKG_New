<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistem Pemeriksaan EKG</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/scichart@4.0.923/index.min.js" crossorigin="anonymous"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f2f9ff;
    }

    .header {
      background-color: #34495e;
      color: white;
      padding: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 6px solid white;
    }

    .header-title {
      font-size: 22px;
      font-weight: 700;
      color: white;
    }

    .logo {
      height: 40px;
      margin-right: 10px;
    }

    .form-button {
      background-color: #34495e;
      color: white;

    }

    .status-bar {
      background-color: #34495e;
      color: white;
      padding: 0.5rem 1rem;
      display: flex;
      justify-content: space-between;
      display: flex;
      align-items: center;
      height: 35px;
    }

    .status.nonaktif {
      background-color: white;
      padding: 0.2rem 0.5rem;
      border-radius: 5px;
      margin-left: 10px;
    }



    .patient-data,
    .actions {
      background-color: #ffffff;
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .actions button {
      margin-right: 10px;
    }

    .patient-section {
      background-color: #34495e;
      /* Background sudah diatur di sini */
      box-shadow: 0px -4px 6px rgba(0, 0, 0, 0.1);
      margin-top: 5px;
      position: relative;
      z-index: 1000;
    }

    .form-control:focus {
      background-color: #2b3035 !important;
      color: white !important;
      border: 1px solid #4285F4 !important;
      box-shadow: none;
    }

    input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
    }

    input[type="date"] {
      color-scheme: light;
    }

    .chart-grid {
      display: grid;
      grid-template-columns: 1fr;
      /* Satu kolom untuk semua grafik */
      gap: 0px;
      /* Jarak antar grafik */
      padding: 0px;
    }

    .chart-grid.two-columns {
      gap: 0px;
      /* jarak kecil, bisa kamu ubah sesuai selera */
    }

    .chart-wrapper {
      position: relative;
      /* Diperlukan untuk penempatan judul absolut */
      width: 100%;
      height: 100px;
      /* Tinggi tetap untuk setiap grafik */
      /* border: 1px solid #e0e0e0; */
      /* Border yang lebih halus */
      box-sizing: border-box;
      background-color: #ffffff;
      /* Latar belakang putih untuk setiap grafik */
      /* border-radius: 8px; */
      /* Sudut membulat */
      /* box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); */
      /* Bayangan yang lebih menonjol */
      overflow: hidden;
      /* Memastikan konten tidak meluap dari sudut membulat */
    }

    .chart-grid.two-columns .chart-wrapper {
      height: 80px;
      /* sesuaikan angka sesuai kebutuhan */
    }

    .chart-title {
      position: absolute;
      top: 5px;
      left: 10px;
      font-size: 1em;
      font-weight: bold;
      color: #333;
      z-index: 10;
      /* Pastikan judul di atas grafik */
    }

    .scichart-root {
      width: 100%;
      height: 100%;
    }

    .chart-grid.two-columns {
      grid-template-columns: repeat(2, 1fr) !important;
    }

    .chart-container-wrapper {
      background-color: #ffffff;
      margin: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* Custom Style untuk Select Box */
    #patientGender {
      /* Mengganti icon panah default dengan SVG warna putih */
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='white' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
      background-size: 10px;
      /* Ukuran panah diperkecil agar pas dengan tinggi 20px */
      background-position: right 1rem center;
      padding-left: 12px !important;

      /* Menghilangkan padding internal agar teks tidak tertekan ke bawah */
      padding-top: 0 !important;
      padding-bottom: 0 !important;
      line-height: 20px;
      /* Samakan dengan height agar teks center sempurna */
    }

    /* Pastikan label juga memiliki tinggi yang sama untuk perataan sempurna */
    .patient-section label {
      line-height: 20px;
      display: inline-block;
    }
  </style>
</head>

<body>
  <header class="header">
    <div class="d-flex align-items-center ">
      <img src="itera.svg" alt="Logo ITERA" class="logo" />
      <img src="bm.svg" alt="Logo ITERA" class="logo" />
      <h5 class="mb-0 ms-2 header-title">Sistem Pemeriksaan Elektrokardiogram</h5>
    </div>
    <div>Selamat Datang!</div>
  </header>
  </div>

  <section class="patient-section py-3 px-5 d-flex justify-content-between align-items-start">
    <div class="d-flex" style="gap: 50px;">
      <div class="d-flex flex-column gap-2">
        <div class="d-flex align-items-center">
          <label class="mb-0 text-white" style="width: 120px; font-size:small;">Nama Pasien</label>
          <input type="text" id="patientName" class="form-control bg-dark text-white border-0"
            style="width: 250px; height: 20px; font-size:small; -webkit-app-region: no-drag;" />
        </div>

        <div class="d-flex align-items-center">
          <label class="mb-0 text-white" style="width: 120px; font-size:small;">Tanggal Lahir</label>
          <input type="date" id="patientDOB" class="form-control bg-dark text-white border-0"
            style="width: 250px; height: 20px; font-size:small; -webkit-app-region: no-drag;" />
        </div>

        <div class="d-flex align-items-center">
          <label class="mb-0 text-white" style="width: 120px; font-size:small;">Tenaga Kesehatan</label>
          <input type="text" id="medicName" class="form-control bg-dark text-white border-0"
            style="width: 250px; height: 20px; font-size:small; -webkit-app-region: no-drag;" />
        </div>
      </div>
      <div class="d-flex flex-column gap-2">
        <div class="d-flex align-items-center">
          <label class="mb-0 text-white" style="width: 120px; font-size:small;">Umur</label>
          <input type="number" id="patientAge" min="1" class="form-control bg-dark text-white border-0"
            style="width: 250px; height: 20px; font-size:small; -webkit-app-region: no-drag;"
            oninput="if(this.value < 1 && this.value !== '') this.value = 1;" />
        </div>
        <div class="d-flex align-items-center">
          <label class="mb-0 text-white" style="width: 120px; font-size:small;">Jenis Kelamin</label>
          <select id="patientGender" class="form-select bg-dark text-white border-0"
            style="width: 250px; height: 20px; font-size:small; -webkit-app-region: no-drag; padding-left: 8px;">
            <option value="Laki-laki">Laki-laki</option>
            <option value="Perempuan">Perempuan</option>
          </select>
        </div>
      </div>
    </div>


    <div class="d-flex flex-column gap-2">

      <!-- BARIS PERTAMA: TOMBOL -->
      <div class="d-flex flex-row gap-2">
        <button class="btn d-flex align-items-center gap-1 p-1" style="background-color: #ffffff; font-size: 0.75rem;">
          <i class="bi bi-record-circle fs-5" style="color: #34495e;"></i>
          <span style="color: #34495e;">Rekam</span>
        </button>

        <button class="btn d-flex align-items-center gap-1 p-1" style="background-color: #ffffff; font-size: 0.75rem;">
          <i class="bi bi-stop-fill fs-5" style="color: #34495e;"></i>
          <span style="color: #34495e;">Berhenti</span>
        </button>
        <button class="btn d-flex align-items-center gap-1 p-1" style="background-color: #ffffff; font-size: 0.75rem;"
          onclick="window.location.href='file.html'">
          <i class="bi bi-folder2-open fs-5" style="color: #34495e;"></i>
          <span style="color: #34495e;">Buka File</span>
        </button>
      </div>

      <!-- BARIS KEDUA: SWITCH -->
      <div class="form-check form-switch mt-1">
        <input class="form-check-input" type="checkbox" role="switch" id="layoutSwitch">
        <label class="form-check-label text-white" for="layoutSwitch">Tampilkan 2 Grafik per Baris</label>
      </div>

    </div>


  </section>

  <div class="chart-container-wrapper">
    <div class="chart-grid" id="chart-grid-container">
    </div>
  </div>

  <div class="modal fade" id="videoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Pratinjau Rekaman</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <video id="previewVideo" controls class="w-100"></video>
        </div>
      </div>
    </div>
  </div>

  <input type="file" id="videoFileInput" accept="video/webm" style="display: none;" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const layoutSwitch = document.getElementById("layoutSwitch");
    const chartGrid = document.getElementById("chart-grid-container");

    const singleColumnOrder = [
      "I", "II", "III", "aVR", "aVL", "aVF",
      "V1", "V2", "V3", "V4", "V5", "V6"
    ];

    const twoColumnOrder = [
      "I", "V1",
      "II", "V2",
      "III", "V3",
      "aVR", "V4",
      "aVL", "V5",
      "aVF", "V6"
    ];

    function reorderChartsByLead(order) {
      const map = {};

      Array.from(chartGrid.children).forEach(el => {
        map[el.dataset.lead] = el;
      });

      chartGrid.innerHTML = "";

      order.forEach(lead => {
        if (map[lead]) {
          chartGrid.appendChild(map[lead]);
        }
      });
    }


    layoutSwitch.addEventListener("change", function () {
      const titles = document.querySelectorAll(".chart-title");

      if (this.checked) {
        chartGrid.classList.add("two-columns");
        reorderChartsByLead(twoColumnOrder);

        titles.forEach(title => {
          title.style.fontSize = "15px";
        });
      } else {
        chartGrid.classList.remove("two-columns");
        reorderChartsByLead(singleColumnOrder);

        titles.forEach(title => {
          title.style.fontSize = "1em";
        });
      }
    });

  </script>



  <script type="module">
    // --- Fungsi USB (tetap sama) ---
    if ('usb' in navigator) {
      async function getComPort() {
        try {
          const devices = await navigator.usb.getDevices();
          if (devices.length > 0) {
            const device = devices[0];
            // document.getElementById('com-port').value = device.productName || device.manufacturerName || 'Unknown Device';
          } else {
            // document.getElementById('com-port').value = 'Tidak ada perangkat USB terhubung';
          }
        } catch (error) {
          console.error('Error mengakses perangkat USB:', error);
          // document.getElementById('com-port').value = 'Gagal mengakses perangkat USB';
        }
      }
      document.addEventListener("DOMContentLoaded", getComPort);
    } else {
      console.warn('API USB tidak didukung di browser ini.');
    }

    // --- Fungsi Rekam Video (tetap sama) ---
    // --- Variabel Global ---
    let mediaRecorder;
    let recordedChunks = [];
    let patientData = {};

    // Cari bagian <script type="module"> untuk Rekam Video
    const rekamBtn = document.querySelector('.bi-record-circle').closest('button');
    const berhentiBtn = document.querySelector('.bi-stop-fill').closest('button');

    rekamBtn.addEventListener('click', async () => {
      // 1. Validasi Input
      const nama = document.getElementById('patientName').value;
      const dob = document.getElementById('patientDOB').value;
      const gender = document.getElementById('patientGender').value;
      const umur = document.getElementById('patientAge').value;
      const tenagaMedis = document.getElementById('medicName').value;

      if (!nama || !dob || !gender || !umur || !tenagaMedis) {
        alert("Lengkapi data terlebih dahulu!");
        document.getElementById('patientName').focus();
        return;
      }

      const patientData = { nama, dob, gender, umur, tenagaMedis };

      try {
        // 2. Ambil ID Jendela Aplikasi (Solusi NotSupportedError)
        const sources = await window.electronAPI.getSources();
        // Cari jendela yang namanya mengandung "EKG"
        const targetSource = sources.find(s => s.name.includes("EKG") || s.name.includes("Electron")) || sources[0];

        const stream = await navigator.mediaDevices.getUserMedia({
          audio: false,
          video: {
            mandatory: {
              chromeMediaSource: 'desktop',
              chromeMediaSourceId: targetSource.id
            }
          }
        });

        // 3. Setup Media Recorder
        mediaRecorder = new MediaRecorder(stream);
        recordedChunks = [];

        mediaRecorder.ondataavailable = e => {
          if (e.data.size > 0) recordedChunks.push(e.data);
        };

        mediaRecorder.onstop = async () => {
          const blob = new Blob(recordedChunks, { type: 'video/webm' });
          const buffer = await blob.arrayBuffer();
          const fileName = `EKG_${patientData.nama}_${Date.now()}.webm`;

          // 4. Panggil IPC untuk Simpan ke SQLite & Folder Downloads
          const result = await window.electronAPI.saveRecord({
            ...patientData,
            videoBuffer: buffer,
            fileName: fileName
          });

          if (result.success) {
            alert("Perekaman telah berhasil disimpan! Cek Folder /Download");
          }
        };

        window.electronAPI.startRecording();
        mediaRecorder.start(1000);
        rekamBtn.disabled = true;
        rekamBtn.innerHTML = '<span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span> Merekam...';
      } catch (err) {
        console.error("Gagal merekam:", err);
        alert("Gagal memulai perekaman. Pastikan izin layar diberikan.");
      }
    });

    berhentiBtn.addEventListener('click', () => {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        window.electronAPI.stopRecording();
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        rekamBtn.disabled = false;
        rekamBtn.innerHTML = '<i class="bi bi-record-circle fs-5"></i> Rekam';
      }
    });

  </script>

  <!-- script sci-chart -->
  <script>
    // 1. Inisialisasi variabel global agar bisa diakses di semua fungsi
    let globalDataSeries = [];
    let xCounts = Array(12).fill(0);
    const maxPoints = 2500;

    const chartTitles = ["I", "II", "III", "aVR", "aVL", "aVF", "V1", "V2", "V3", "V4", "V5", "V6"];
    const colors = ["#4285F4", "#EA4335", "#34A853", "#FBBC05", "#8E24AA", "#00ACC1", "#FF7043", "#7CB342", "#FDD835", "#5C6BC0", "#D81B60", "#00897B"];

    // 2. Fungsi Utama Inisialisasi Grafik
    async function initSciChart() {
      const {
        SciChartSurface,
        NumericAxis,
        FastLineRenderableSeries,
        XyDataSeries,
        NumberRange
      } = SciChart;

      const chartGridContainer = document.getElementById("chart-grid-container");
      chartGridContainer.innerHTML = ""; // Bersihkan kontainer sebelum membuat baru

      for (let i = 1; i <= 12; i++) {
        // Membuat Elemen HTML (Wrapper)
        const chartWrapper = document.createElement("div");
        chartWrapper.className = "chart-wrapper";
        chartWrapper.dataset.lead = chartTitles[i - 1];
        chartGridContainer.appendChild(chartWrapper);

        const titleDiv = document.createElement("div");
        titleDiv.className = "chart-title";
        titleDiv.textContent = chartTitles[i - 1];
        chartWrapper.appendChild(titleDiv);

        const scichartRootDiv = document.createElement("div");
        scichartRootDiv.id = `scichart-root-${i}`;
        scichartRootDiv.className = "scichart-root";
        chartWrapper.appendChild(scichartRootDiv);

        // Inisialisasi Surface SciChart
        const { sciChartSurface, wasmContext } = await SciChartSurface.create(scichartRootDiv.id);

        sciChartSurface.chartBackground = "#FFFFFF";
        sciChartSurface.plotAreaBackground = "#FFFFFF";
        sciChartSurface.background = "white";
        sciChartSurface.drawBackground = "white";
        sciChartSurface.chartBackground = "white";
        sciChartSurface.plotAreaBackground = "white";

        // Hilangin jarak antar grafik
        sciChartSurface.padding = new SciChart.Thickness(0, 0, 0, 0);

        // Konfigurasi Visual (Sesuai gaya Merah Anda)
        sciChartSurface.background = "white";

        // Sumbu X
        sciChartSurface.xAxes.add(new NumericAxis(wasmContext, {
          visibleRange: new NumberRange(0, maxPoints),
          autoTicks: false,
          majorDelta: 100,
          minorDelta: 20,
          drawLabels: false,
          drawMajorBands: false,
          drawMajorGridLines: false,
          drawMinorGridLines: false,
          // majorGridLineStyle: { stroke: "rgba(255, 0, 0, 0.4)", strokeThickness: 1 },
          // minorGridLineStyle: { stroke: "rgba(255, 0, 0, 0.1)", strokeThickness: 0.5 },
        }));

        // Sumbu Y
        sciChartSurface.yAxes.add(new NumericAxis(wasmContext, {
          visibleRange: new NumberRange(-1.5, 1.5),
          drawMajorGridLines: false,
          drawMinorGridLines: false,
          drawMajorTicks: false,
          drawMinorTicks: false,
          drawLabels: false,
          drawMajorBands: false,
          majorDelta: 500,
          minorDelta: 100,
          // majorGridLineStyle: { stroke: "rgba(255, 0, 0, 0.4)", strokeThickness: 1 },
          // minorGridLineStyle: { stroke: "rgba(255, 0, 0, 0.1)", strokeThickness: 0.5 },
        }));

        // Series Data
        // Ganti bagian inisialisasi Data Series di dalam loop for initSciChart:
        const dataSeries = new XyDataSeries(wasmContext, { containsNaN: true });

        // --- TAMBAHKAN INI: Pre-fill dengan NaN agar buffer memiliki ukuran tetap ---
        const xInitial = [];
        const yInitial = [];
        for (let j = 0; j < maxPoints; j++) {
          xInitial.push(j);
          yInitial.push(NaN);
        }
        dataSeries.appendRange(xInitial, yInitial);
        // --------------------------------------------------------------------------

        const lineSeries = new FastLineRenderableSeries(wasmContext, {
          stroke: colors[i - 1],
          strokeThickness: 2,
          dataSeries: dataSeries
        });

        sciChartSurface.renderableSeries.add(lineSeries);

        // Simpan series ke array global agar bisa di-update dari WebSocket
        globalDataSeries.push(dataSeries);
      }

      console.log("✅ 12 Grafik SciChart berhasil diinisialisasi");
    }

    // 3. Jalankan inisialisasi saat halaman siap
    document.addEventListener("DOMContentLoaded", () => {
      initSciChart();
    });

    function parseBinaryPacket(buffer) {
      const view = new DataView(buffer.buffer, buffer.byteOffset, buffer.byteLength);

      // Cek Marker: Byte 0 (0xAA) dan Byte 1 (0x55)
      if (view.getUint8(0) !== 0xAA || view.getUint8(1) !== 0x55) return null;

      // FIX: Gunakan getFloat32, bukan getUint32
      const timestamp = view.getFloat32(2, true);

      const nch = view.getUint8(6);

      const values = [];
      for (let i = 0; i < nch; i++) {
        const offset = 7 + (i * 2);
        if (offset + 1 < buffer.length) {
          // Ambil nilai mentah dan bagi 2048 jika ingin melihat nilai float (-1 ke 1)
          let rawVal = view.getInt16(offset, true);
          values.push(rawVal / 2048.0); // Sekarang nilainya akan sama dengan UI Python (0.00x)
        }
      }
      return { timestamp, nch, values };
    }

    // 4. Listener Data Realtime dari WebSocket (Python -> index.js -> preload.js)
    if (window.electronAPI && window.electronAPI.onEcgRealtime) {
      window.electronAPI.onEcgRealtime((payload) => {
        const buffer = new Uint8Array(payload.raw);
        const packetSize = 33; // Sesuaikan dengan ukuran paket dari Python (Header 2 + TS 4 + Nch 1 + Data 2*13 = 33)

        // Loop untuk memproses setiap paket dalam buffer yang diterima
        for (let offset = 0; offset < buffer.length; offset += packetSize) {
          const view = new DataView(buffer.buffer, buffer.byteOffset + offset, packetSize);

          // Validasi Header
          if (view.getUint8(0) !== 0xAA || view.getUint8(1) !== 0x55) continue;

          const nch = view.getUint8(6);

          for (let i = 0; i < 12; i++) { // Kita hanya ambil 12 lead utama
            if (globalDataSeries[i]) {
              const ds = globalDataSeries[i];
              const xPos = xCounts[i] % maxPoints;

              // 1. Ambil nilai dari buffer (Byte ke-7 adalah awal data channel)
              const rawVal = view.getInt16(7 + (i * 2), true);
              const valFloat = rawVal / 2048.0;

              // 2. Circular Writing: Gunakan UPDATE, bukan APPEND
              ds.update(xPos, valFloat);

              // 3. Gap Creation: Hapus data di depan pointer (sama seperti Python)
              const gapWidth = 40; // Sesuaikan lebar celah penghapusan
              for (let g = 1; g <= gapWidth; g++) {
                const gapPos = (xPos + g) % maxPoints;
                ds.update(gapPos, NaN);
              }

              xCounts[i]++;
            }
          }
        }
      });
    } else {
      console.error("❌ API Electron tidak ditemukan. Pastikan preload.js sudah benar.");
    }
  </script>




  <script>
    // =========================================
    // 1. FUNGSI MEMBUAT GRID DI PDF
    // =========================================
    function drawEcgGrid(pdf, startX, startY, width, height) {
      const small = 5;
      const large = 25;

      pdf.setLineWidth(0.1);
      pdf.setDrawColor(255, 150, 150);

      for (let x = startX; x < startX + width; x += small) {
        pdf.line(x, startY, x, startY + height);
      }
      for (let y = startY; y < startY + height; y += small) {
        pdf.line(startX, y, startX + width, y);
      }

      pdf.setLineWidth(0.4);
      pdf.setDrawColor(255, 80, 80);

      for (let x = startX; x < startX + width; x += large) {
        pdf.line(x, startY, x, startY + height);
      }
      for (let y = startY; y < startY + height; y += large) {
        pdf.line(startX, y, startX + width, y);
      }
    }
  </script>

  <script>
    // =========================================
    // 3. GENERATE PDF 12 LEAD
    // =========================================
    async function generateEcgPdf(allEcgData) {
      const pdf = new jspdf.jsPDF("p", "pt", "a4");

      const chartsPerPage = 12;
      const pointsPerPage = 2000;

      const chartWidth = 250;
      const chartHeight = 150;

      let chartIndex = 0;

      const leads = [
        "Lead_1", "Lead_2", "Lead_3", "Lead_4", "Lead_5", "Lead_6",
        "Lead_7", "Lead_8", "Lead_9", "Lead_10", "Lead_11", "Lead_12"
      ];

      while (chartIndex < leads.length) {
        pdf.setFontSize(14);
        pdf.text("Laporan EKG", 40, 40);

        let yPos = 80;

        for (let i = 0; i < chartsPerPage && chartIndex < leads.length; i++) {

          const lead = leads[chartIndex];
          const yData = allEcgData[lead].slice(0, pointsPerPage);

          drawEcgGrid(pdf, 40, yPos - 10, chartWidth, chartHeight);

          // Buat chart SciChart sementara
          const { sciChartSurface, wasmContext } =
            await SciChart.SciChartSurface.createSingle("tempChart");

          const dataSeries = new SciChart.XyDataSeries(wasmContext);
          yData.forEach((y, idx) => dataSeries.append(idx, y));

          sciChartSurface.renderableSeries.add(
            new SciChart.FastLineRenderableSeries(wasmContext, {
              stroke: "red",
              strokeThickness: 2,
              dataSeries
            })
          );

          const pngBase64 = await sciChartSurface.exportToPng();
          pdf.addImage(pngBase64, "PNG", 40, yPos, chartWidth, chartHeight);

          await sciChartSurface.delete();

          yPos += chartHeight + 20;
          chartIndex++;
        }

        if (chartIndex < leads.length) pdf.addPage();
      }

      pdf.save("laporan_ekg.pdf");
    }
  </script>

  <script>
    let GLOBAL_ECG_DATA = null;

    // dipanggil setelah CSV selesai diparse
    function afterCsvLoaded(allEcgData) {
      GLOBAL_ECG_DATA = allEcgData;
      initSciChart(allEcgData);
    }

    function downloadPdf() {
      if (!GLOBAL_ECG_DATA) {
        alert("Data EKG belum dimuat!");
        return;
      }
      generateEcgPdf(GLOBAL_ECG_DATA);
    }
  </script>

  <!-- <script>
    async function downloadPdf() {
      console.log("Simpan PDF ditekan");

      // ambil semua chart
      const chartDivs = document.querySelectorAll(".scichart-root");
      if (chartDivs.length === 0) {
        alert("Grafik belum siap!");
        return;
      }

      // gunakan jsPDF
      const { jsPDF } = window.jspdf;

      const pdf = new jsPDF({
        orientation: "portrait",
        unit: "mm",
        format: "a4"
      });

      let yPos = 10;

      for (let i = 0; i < chartDivs.length; i++) {
        const sc = chartDivs[i].sciChartSurface;
        const image = await sc.exportToPng();

        pdf.addImage(image.src, "PNG", 10, yPos, 190, 40);

        yPos += 45;

        // halaman baru jika penuh
        if (yPos > 260) {
          pdf.addPage();
          yPos = 10;
        }
      }

      pdf.save("ekg_record.pdf");
    }
  </script> -->

  <!-- tambahkan library jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</body>

</html>